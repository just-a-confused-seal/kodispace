<html>
    <head>
        <title>
            Kodi Space - Mini Website Portal 
        </title>
        <style>
            body {
                font-family: Consolas,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New, monospace;;
                margin: 0;
                background-color: #f4f4f4;
            }

            .navbar {
                overflow: hidden;
                background-color: #000000;
            }

            .navbar a,
            .navbar img {
                float: left;
                display: block;
                padding: 14px 16px;
            }

            .navbar a {
                font-size: 30px;
                color: white;
                text-align: center;
                text-decoration: none;
            }

            .navbar p {
                font-size: 20px;
                color: white;
                text-align: center;
                padding: 14px 16px;
                margin: 0;
            }

            .navbar img {
                width: 40px;
                height: 40px;
                padding: 10px 16px;
            }

            .navbar a:hover {
                background-color: red;
            }

            /* Table styling */
            table {
                width: auto;
                border-collapse: collapse;
                margin-top: 20px;
                margin-left: 20px;
            }

            table td {
                font-size: 18px;
                background-color: white;
                border: 2px solid #999;
                padding: 15px 20px; /* very small padding */
            }

            table td + td {
                margin-left: 0;
            }

            .wide-table {
                width: 98%;
                border-collapse: collapse;
                margin: 20px auto;
            }

            .table-box{
                margin: 0px;
            }

            .td-box {
                border: 1px solid #333;
                border-radius: 15px;
                padding: 5px 10px;
                margin-right: 10px;
                background-color: #f9f9f9;
                display: inline-block;
                font-size: 14px;
            }

            .collapsible {
                background-color: white;
                width: 100%;
                border: none;
                text-align: left;
                outline: none;
                font-size: 20px;
                font-weight : bold ;
                font-family: Consolas,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New, monospace;;
            }

            .content {
                display: none;
                overflow: hidden;
            }

            .center {
                display: block;
                margin-right: auto;
                padding: 15px 10px;
            }

        </style>
    </head>
    <body>
        <div class="navbar">
            <img src="../images/logo.webp" alt="Logo">
            <a href="javascript:history.back()">~# KODI SPACE</a>
            <p> ---------------------{  Malware is Malicious!! }--------------------- </p>
        </div>

        <table>
            <tr><td>kodi@kodi-Github-IO:~$ cat Malware Analysis/deobfuscate_web_backdoor.html</td></tr>
        </table>
        <!-- Table Section -->
        <table class="wide-table">
            <tr>
                <td>
                    <img src="image/onions-cutting.gif" width="100px" height="100px">
                    <h1> Peeling Back the Payload: Deobfuscating a Web Backdoor - Part 1</h1>
                    <table class="table-box">
                        <td class="td-box">
                            #PHP
                        </td>
                        <td class="td-box">
                            #Malware Analysis
                        </td>
                    </table>
                    <p></p>
                </td>
            </tr>
        </table>

        <table class="wide-table">
            <tr>
                <td>
                        <button type="button" class="collapsible">Background</button>
                        <div class="content">
                           <p>One or two years ago, I remember one of my student ask me to help them dealing with one of incident occurred in their company. It is about analyzing web backdoor injected to their website, long story short they managed to found backdoor but got some problem figuring out what's happening inside the backdoor since its heavily obfuscated. Thus, in this post we will go through on how to deobfuscated php backdoor and turns out its deeper than I thought so that's why I want to make this into two parts. The first part we will reverse engineer the dropper which act as a downloader to install the real backdoor that established the connection between the malware author to the infected machine.</p>

                        <p>Note:
                           <ul>
                                <li>I have stripped all the information that could lead to the infected machine to preserve anonymity.</li>
                                <li>I will not shared the obfuscated source code as I'm aware the possiblity that it could be used for something bad. </li>
                                <li>All information contain in this blog is purely strict only for education any attempt to replicate the work to cause descruction to a live system is prohibited and the author is not accountable for the action.</li>
                           </ul>
                        </p>
                        </div>
                </td>
            </tr>
        </table>

        <table class="wide-table">
            <tr>
                <td>
                        <button type="button" class="collapsible">General Overview</button>
                        <div class="content">
                            <p>The following is the source code of PHP backdoor:</p>
                            <img src="image/php_obfuscated.png" width="800" height="400" class="center">
                            <p>I put two red boxes so that we are not overwhelmed by the complexity of the program. To anyone who doesn't know about obfuscation lemme give you some heads up, basically it is a technique that make source code less readable. Why someone wants to make their code less readable? half of them wants to protect their source code secrecy from reverse engineer, while the other half wants to make sure their code is not triggering any alarm.</p>
                            <p>I'm not pretty sure how windows defender would react to a php backdoor, thus, if you download the file from the link I shared from the above it will be in .zip file and the original file will be using .txt extension. I do this because I just to make sure your sample don't get quarantine by windows defender or if you like me you can just download it and open it in virtual machine.</p>
                        </div>
                </td>
            </tr>
        </table>

        <table class="wide-table">
            <tr>
                <td>
                        <button type="button" class="collapsible">Deobfuscate - 1st part of the source code</button>
                        <div class="content">
                            <img src="image/part1.png" width="800" height="100" class="center">
                            <p>To a first timer, this could be considered overwhelmed because of how long and complicated the line is but again you need to set your mind right. My tip is to always focus on what you know! Let's focus on the first line we could see the program set a variable called string_url and it assign with value from urldecode() function. According to <a href="https://www.php.net/manual/en/function.urldecode.php">PHP documentation</a> the function was meant to decodes any code that starts with %## and you can actually look it up manually for the encoding from the following <a href="https://www.w3schools.com/tags/ref_urlencode.ASP">website</a>. So nothing fancy here, encoding and decoding is just mapping character to its respective code. It is created to make sure computer can represent information into more suitable format due to vast range of characters.</p>

                            <p>This is a typical strategy used by malware author to overwhelmed the engineer because we are not used to reading and understanding this format. You can actually decode using any online tools outhere but here I just going to use online php compiler and try to print the value like this:</p>
                            
                            <img src="image/php1.png" width="800" height="200" class="center">
                            
                            <p>We got a random characters! but it's okay, we can continue the rest of the code. We can see there are 12 variables and they have kinda cryptic name but again don't focus on the name, this is typical way how malware author make you confuse they try to name their variable with an odd name but if you look closely it is acceptable syntax wise. As long as the name of the variable is not start with number this will consider valid according to php interpreter, thus, I recommend not to focus on the name but rather focus what's the value.</p>

                            <p>When looking at assigning value to the variable, we notice that it actually accessing the value from string_url variable via index like $string_url{30}. But accessing value from index supposed to using [] instead of {}? yes! it is possible and consider valid until php 8.0+ <a href="https://www.php.net/manual/en/migration74.deprecated.php">references</a>.</p>

                            <p>Lets stich each of the variable in online compiler print what's the value like this:</p>
                            <img src="image/php2.png" width="800" height="450" class="center">
                            <p>Ok we got something interesting result, we can see that this odd variable contain a name that similar to php function.</p>
                            <ul>
                            <li>$O000OOO___     => file_put_contents</li>
                            <li>$O_0O_0O0O_     => file_get_contents</li>
                            <li>$O0_O0_O0O_     => create_function</li>
                            <li>$OOO0_O0_0_     => base64_encode</li>
                            <li>$OO0O___0O0     => base64_decode</li>
                            <li>$O_O_0_O00O     => preg_replace</li>
                            <li>$O_00O0OO__     => str_replace</li>
                            <li>$O_0_O0_O0O     => curl_setopt</li>
                            <li>$O_O_O000_O     => curl_close</li>
                            <li>$O___00OO0O     => serialize</li>
                            <li>$O__0O0_0OO     => curl_init</li>
                            <li>$O_OO_O000_     => curl_exec</li>
                            </ul>
                            <p>We are gonna keep the list as it is for now. There may be a chance this could be used on the second part.</p>
                        </div>
                </td>
            </tr>
        </table>

        <table class="wide-table">
            <tr>
                <td>
                        <button type="button" class="collapsible">Deobfuscate - 2nd part of the source code</button>
                        <div class="content">
                            <img src="image/php3.png" width="800" height="400" class="center">
                            <p>The first thing that I notices when I look at the second part of the source code is that there are a lot of hexadecimal string encode, which is "\x". Just as I mentioned before malware author like to encode everything just to make things difficult. It's actually not that hard restore the hexadecimal string to original form, we could used sed magic like this:</p>
                            <img src="image/php4.png" width="800" height="400" class="center">
                            <p>We managed to decode the hexadecimal but if you look closely again there are couple variable from the 1st part like for example $O_00O0OO__, $O___00OO0O and $OO0O___0O0 is used throughout the second part. Let's start mapping the variable to original value like this:</p>
                            <img src="image/php5.png" width="800" height="400" class="center">
                            <p>Ok! We are able to mapped variable from 2nd part into original value and for variable that is not listed in part 1, I just named as $var1-5 think this as a placeholder name for local variable name and you can actually put whatever name that suits you. Before formatting those three variable into more readable source code notice that each variable has always start with ${"GLOBALS"}["create_function"] if you don't know what it means, this is the process on how to create a lambda function. Lambda function is basically anonymous function.</p>

                            <p>To understand the mechanism of lambda function in this context, lets go through the logic one by one, the first part is ${"GLOBALS"} this means that the program try to access global variables and the global variables they want to access is create_function this is actually inline with what we found at first part because from this finding we can be sure that the first part is actually initialization for "global" variable that later will be access and assembled to a function in second part.</p>

                            <p>According to <a href="https://www.php.net/manual/en/function.create-function.php">documentation</a> create_function is a function that used to creates a function dynamically from the parameters passed, and returns a unique name for it. This function takes two parameter which are first is the argument that will passed to the function and second parameter will be the actual code of the function. </p>

                            <p>If that's clear, we almost there to truly deobfuscated the backdoor. Lets format the source code so it's easier to read. You can use any formatter or you can do it by yourself, like I do. We start with the first function:</p>

                            <img src="image/function1.png" width="800" height="200" class="center">

                            <p>The first function functionality is pretty simple, it only return the ip address or hostname of the website that has been injected by backdoor. $_SERVER is an array containing information such as headers, paths, and script locations that is generated automatically by web server.</p>

                            <img src="image/function2.png" width="800" height="300" class="center">

                            <p>The second function is more interesting as its actually utilized some function from 1st part. The bottom line is that the function try to get a file through file_get_contents function and if it does not work it will switch to using curl utility function. What file that are retrieved by the backdoor? you curious? stay tuned I will write a second part for this post :D.</p>

                            <img src="image/function3.png" width="669" height="891" class="center">

                            <p>I would consider the third function is the main function, which consolidate everything that we analyzed so far.</p>
                            <ul>
                                <li>First section is to initialize all of the required variable including the server ip address and hostname via first function.</li>
                                <li>Second section is a logic to delete the backdoor, I assume this some kind of like process to delete their trace inside the server to avoid being detected.</li>
                                <li>Third section is a logic to download the payload which is this case stored in 51la.izv4.com(as of today the domain has been shutdown and you cannot visited it), we can safely point out that this is the payload of reverse shell that established the backdoor connection. </li>
                                <li>The last section is sending the result of the execution whether is a success or not to 51la.adcef.com and finally(as of today the domain has been shutdown and you cannot visited it), if you can see at the bottom the third function was triggered or called.</li>
                            </ul>
                        </div>
                </td>
            </tr>
        </table>

        <table class="wide-table">
            <tr>
                <td>
                        <button type="button" class="collapsible">Evaluating the Result and Thoughts on Reverse Engineering</button>
                        <div class="content">
                            <p>To summarize everything we've analyzed so far: malware often heavily obfuscates its backdoor components to avoid detection by antivirus software. Despite this, reverse engineering can often be used to deobfuscate and analyze the malware. Through this process, we can extract Indicators of Compromise (IOCs) and use them as references for handling future incidents more effectively.</p>
                            
                            <p> In my opinion, the importance of reverse engineering skills cannot be overstated. Whether you're part of a red team or a blue team, this capability is crucial for day-to-day operations. Unfortunately, I've observed that many newcomers in cybersecurity tend to chase quick financial gains—often gravitating toward application security—while overlooking the elegance and depth of reverse engineering. This has turned what was once a respected craft into something of a lost art.</p>
                            
                            <p>While there's nothing inherently wrong with seeking financial rewards in cybersecurity, it's important to remember that this field is also about creativity, curiosity, and passion—not just money. </p>
                        </div>
                </td>
            </tr>
        </table>


    <script>
            var coll = document.getElementsByClassName("collapsible");
            var i;

            for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                content.style.display = "none";
                } else {
                content.style.display = "block";
                }
            });
            }
    </script>
    </body>
</html>
